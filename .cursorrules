# OPCS Onboarding System - Cursor Rules

## Project Overview
This is an HR onboarding application for Optimal Prime Cleaning Services with full US federal compliance. It uses Vue 3 frontend, Node.js/Express backend, and SQLite database.

## Architecture Principles

### Data Privacy & Security
- **NEVER store SSNs in the database** - SSNs only go in PDFs, never persisted
- Always encrypt sensitive documents and settings using AES-256-GCM
- Use session-based authentication with HTTP-only cookies
- All document access must be audit logged

### Database Design
- Use SQLite with `better-sqlite3`
- Follow compliance-focused schema (see `backend/src/database/init.js`)
- Never include SSN fields in database tables
- Use proper foreign keys and indexes

### Frontend Patterns
- Use Vue 3 Composition API with `<script setup>`
- Use Pinia for state management
- Use composables for reusable logic (`useApplicantData`, `useFormDraft`)
- Follow Tailwind CSS utility-first approach
- Use the color scheme from `optimalprimeservices.com`

### Backend Patterns
- Use ES6 modules (import/export)
- Separate concerns: routes, services, middleware
- Always use `requireAuth` middleware for protected routes
- Use `requireAdmin` middleware for admin-only routes
- Use `auditLog` for compliance tracking
- Handle errors gracefully with proper HTTP status codes
- Normalize user input: trim whitespace, lowercase emails for consistency
- First user in system automatically becomes admin (see `createApplicant` in `auth.js`)
- Admin users require password authentication (non-admins use name/email only)
- Admin passwords stored as bcrypt hashes in `password_hash` column
- Default password 'opcs' used for testing when admin password not set (see `init.js`)

## Code Style

### JavaScript/Vue
- Use ES6+ features (async/await, destructuring, arrow functions)
- Use camelCase for variables and functions
- Use PascalCase for Vue components
- Use descriptive variable names
- Add JSDoc comments for complex functions

### File Naming
- Components: PascalCase (`Step1W4Form.vue`)
- Utilities: camelCase (`validation.js`)
- Services: camelCase (`pdfService.js`)
- Routes: camelCase (`auth.js`)

### Vue Component Structure
```vue
<template>
  <!-- Template content -->
</template>

<script setup>
// Imports
// Props/Emits
// Reactive state
// Computed properties
// Methods
// Lifecycle hooks
</script>
```

## Key Features to Maintain

### Form Workflow
- 6-step process: W-4, I-9, Background, Direct Deposit, Acknowledgements, 8850
- Auto-save drafts every 2 seconds (debounced)
- Manual save button on each form
- Clickable breadcrumb navigation with validation
- Step dependencies enforced (can't skip steps)

### Field Auto-population
- First name, last name, email from signup → locked after Step 1
- Phone number from signup → locked if provided
- Middle name → editable (optional)
- All other fields → editable

### Validation
- US phone numbers only: (XXX) XXX-XXXX format
- Email validation with format checking
- Real-time validation with error messages
- Field-level tooltips explaining requirements

### Form Labeling Standards (REQUIRED)
All form fields must follow the standardized labeling pattern established in Step 6 (8850 form):

1. **Required Fields:**
   - Use red asterisk: `<span class="text-red-500">*</span>`
   - Add required indicator: `<span class="ml-1 text-xs text-red-600">(Required)</span>`
   - Example: `First Name <span class="text-red-500">*</span> <span class="ml-1 text-xs text-red-600">(Required)</span>`

2. **Auto-filled Fields:**
   - Show green indicator when field has value: `<span v-if="formData.fieldName" class="ml-1 text-xs text-green-600">(Auto-filled)</span>`
   - Locked fields use: `readonly` attribute, `bg-gray-100 cursor-not-allowed` classes
   - Add helper text: `<p class="mt-1 text-xs text-gray-500">Pre-filled from [source] - cannot be changed</p>`

3. **Info Boxes:**
   - Use blue info box for auto-population notices: `bg-blue-50 border-l-4 border-blue-400 rounded-md`
   - Text color: `text-blue-800`
   - Start with: `<strong>Auto-population:</strong>`

4. **Field States:**
   - Locked/readonly: Gray background (`bg-gray-100`), cursor-not-allowed
   - Required but empty: Red border (`border-2 border-red-300`) with error message
   - Auto-filled: Green indicator text, locked styling

5. **Consistency:**
   - All forms must use the same labeling pattern
   - All info boxes must use the same blue styling
   - All required field indicators must be consistent
   - Reference: `frontend/src/components/forms/Step68850Form.vue` as the standard

### Google Integration
- Google Drive API for document storage
- Google Maps Places API for address autocomplete
- API keys stored encrypted in settings table
- Public endpoint for Maps API key (authenticated users)

## Important Files

### Backend
- `backend/src/database/init.js` - Database schema (DO NOT add SSN fields)
- `backend/src/services/pdfService.js` - PDF generation (SSN included here only)
- `backend/src/services/encryptionService.js` - AES-256-GCM encryption
- `backend/src/middleware/auth.js` - Authentication helpers (includes `createApplicant`, `findApplicantByCredentials`, normalization)
- `backend/src/routes/forms.js` - Form submission and draft management
- `backend/src/routes/admin.js` - Admin routes (dashboard, document access, utilities)

### Frontend
- `frontend/src/views/FormWizardView.vue` - Main form wizard with breadcrumbs
- `frontend/src/components/forms/Step1W4Form.vue` - W-4 form (reference implementation)
- `frontend/src/composables/useFormDraft.js` - Draft auto-save logic
- `frontend/src/composables/useApplicantData.js` - Applicant data loading
- `frontend/src/utils/validation.js` - Phone/email validation

### Docker
- `Dockerfile` - Combined multi-stage build (frontend + backend in single container)
- `backend/Dockerfile` - Backend-only service image
- `frontend/Dockerfile` - Frontend-only nginx image
- `docker-compose.yml` - Production deployment configuration
- `docker-compose.dev.yml` - Development with hot reload
- `frontend/nginx.conf` - Nginx configuration for frontend and API proxy

## Documentation Requirements

### ALWAYS Update Documentation
- **README.md MUST be updated** whenever:
  - Adding new features or functionality
  - Changing API endpoints or routes
  - Adding new dependencies
  - Modifying database schema
  - Changing authentication or security features
  - Updating environment variables or configuration
- **CONTRIBUTING.md MUST be updated** whenever:
  - Adding new development workflows
  - Changing code style or conventions
  - Adding new testing requirements
  - Modifying setup or installation procedures
  - Updating contribution guidelines

### Documentation Standards
- Keep README.md current with all features and setup instructions
- Keep CONTRIBUTING.md current with development practices
- Include code examples where helpful
- Document breaking changes clearly
- Update API documentation sections when endpoints change

## When Adding Features

### New Form Fields
1. Add to form component's `formData` ref
2. Add validation if required
3. Add tooltip if field needs explanation
4. Update PDF generation service if needed
5. **Never add SSN fields to database**
6. **Update README.md** with field description if significant

### New API Endpoints
1. Add route in appropriate `routes/` file
2. Use `requireAuth` middleware
3. Add `auditLog` for sensitive operations
4. Handle errors with proper status codes
5. **Update API documentation in README.md** - REQUIRED
6. **Update CONTRIBUTING.md** if endpoint affects development workflow

### New Dependencies
1. Install in appropriate directory (backend/ or frontend/)
2. Update package.json
3. **Document in README.md** - REQUIRED if significant
4. Consider security implications
5. **Update CONTRIBUTING.md** if installation/setup changes

## Compliance Requirements

**IMPORTANT**: See `COMPLIANCE.md` for complete compliance documentation, including federal regulations and South Dakota state-specific requirements.

### Document Retention
- I-9: 3 years after hire or 1 year after termination (whichever is later)
- W-4: 4 years after last payment
- Background checks: Per FCRA requirements (5 years recommended)
- All retention dates calculated in `retentionService.js`
- **Reference**: `COMPLIANCE.md` for complete retention schedule

### Audit Logging
- All document access must be logged
- All form submissions must be logged
- Include: user ID, action, resource type, IP address, user agent, timestamp
- **Reference**: `COMPLIANCE.md` for complete audit logging requirements

### Privacy
- SSN collection requires explicit consent (PrivacyNotice component)
- SSNs never stored in database
- SSNs temporarily stored in browser cookie (1 hour expiration) for user convenience
  - Cookie name: `temp_ssn`
  - Expires after 1 hour
  - Auto-populates SSN fields in Step 1 (W-4) and Step 6 (8850)
  - Uses secure cookie settings (SameSite=Strict, Secure in production)
  - See `frontend/src/utils/cookies.js` for implementation
- All sensitive data encrypted at rest
- Session data secured with HTTP-only cookies
- **Reference**: `COMPLIANCE.md` for complete privacy requirements

### Compliance Checklists
- **ALWAYS** review `COMPLIANCE.md` before making changes that affect:
  - Document retention
  - Data storage
  - Privacy features
  - Audit logging
  - Form requirements
- Use compliance checklists in `COMPLIANCE.md` for:
  - Pre-deployment reviews
  - Monthly compliance checks
  - Quarterly compliance reviews
  - Annual compliance audits

## Testing Considerations

### Testing Framework
- **Backend**: Jest with ES modules support
- **Frontend**: Vitest with Vue Test Utils
- **Test Files**: Located in `__tests__/` directories
- **Reference**: See `TESTING.md` for complete testing guide

### Running Tests
- Backend: `cd backend && npm test`
- Frontend: `cd frontend && npm test`
- Coverage: `npm run test:coverage` in respective directories

### Before Deploying
- Run all tests: `npm test` in both backend and frontend
- Verify SSNs are not in database queries
- Test form validation (phone, email)
- Test draft saving/loading
- Test step navigation with dependencies
- Verify PDF generation includes SSN correctly
- Test Google Drive upload (or local storage fallback)
- Verify encryption is working
- Check test coverage meets minimum (80% for critical paths)
- Test Docker build: `docker build -t test .`
- Test Docker container runs: `docker run --rm -p 8888:80 -e SESSION_SECRET=test test`

## CI/CD (GitHub Actions)

### Workflow Files
- `.github/workflows/ci.yml` - Continuous integration (lint, test, build)
- `.github/workflows/release.yml` - Release workflow (test, build, publish images)

### CI Pipeline
1. **Lint**: Run ESLint on frontend and backend
2. **Test Backend**: Jest tests with coverage
3. **Test Frontend**: Vitest tests with coverage
4. **Build Docker**: Build all three image variants

### Release Pipeline
1. Triggered by version tags (`v*`)
2. Runs full test suite
3. Builds and pushes Docker images to GitHub Container Registry
4. Creates GitHub release with Docker pull instructions

### Docker Image Tags
- `ghcr.io/{repo}:latest` - Combined image (latest)
- `ghcr.io/{repo}:v*` - Combined image (version tagged)
- `ghcr.io/{repo}-backend:latest` - Backend only
- `ghcr.io/{repo}-frontend:latest` - Frontend only

## Common Pitfalls to Avoid

1. **Don't add SSN fields to database schema**
2. **Don't skip step validation** - always check prerequisites
3. **Don't forget audit logging** for sensitive operations
4. **Don't hardcode API keys** - use settings table
5. **Don't bypass authentication** - use middleware
6. **Don't store unencrypted sensitive data**

## Color Scheme

Use Tailwind config colors from `frontend/tailwind.config.js`:
- Primary: Blue (#1e40af)
- Primary Light: Lighter blue for hover states
- Secondary: Gray tones
- Success: Green
- Warning: Yellow
- Error: Red

## Port Configuration

- Backend: 3000 (configurable via `PORT` env var)
- Frontend: 9999 (configurable in `vite.config.js`)
- Docker combined image: 80 (nginx) + 3000 (backend)
- Check for port conflicts before starting

## Docker Development

### Docker Setup
- **Combined image** (`Dockerfile`): Full-stack in single container (nginx + backend)
- **Backend image** (`backend/Dockerfile`): API-only for microservices
- **Frontend image** (`frontend/Dockerfile`): nginx serving Vue app
- **Docker Compose**: Use for multi-service deployment

### Docker Files
- `Dockerfile` - Root combined image
- `backend/Dockerfile` - Backend service
- `frontend/Dockerfile` - Frontend service
- `docker-compose.yml` - Production multi-service
- `docker-compose.dev.yml` - Development with hot reload
- `.dockerignore` - Files to exclude from builds

### Building Images
```bash
# Combined image
docker build -t opcs-onboarding .

# Backend only
docker build -t opcs-backend -f backend/Dockerfile backend/

# Frontend only
docker build -t opcs-frontend -f frontend/Dockerfile frontend/
```

### Running with Docker Compose
```bash
# Production
docker-compose up -d

# Development (with hot reload)
docker-compose -f docker-compose.dev.yml up
```

### Environment Variables for Docker
- `SESSION_SECRET` - **Required** - Session encryption key
- `ENCRYPTION_KEY` - AES-256 key for data encryption
- `NODE_ENV` - Environment mode (production/development)
- `PORT` - Backend server port (default: 3000)
- `FRONTEND_URL` - Frontend URL for CORS
- Google API credentials (configured via Settings page)

## Git Workflow

### Commit Philosophy
- **DO NOT commit automatically** - Always itemize changes first and let the user review before committing
- **Atomic commits are mandatory**: Each commit should represent ONE logical change that can be reverted independently
- **Separate features from implementation details**: Break work into logical units based on:
  1. **Feature commits**: User-facing functionality (e.g., "add address validation")
  2. **Fix commits**: Bug fixes (e.g., "fix Google Drive credential check")
  3. **Refactor commits**: Code improvements without behavior change
  4. **Style commits**: UI/UX changes
  5. **Docs commits**: Documentation updates

### Commit Structure
- **Follow Conventional Commits**: Use the conventional commit format
  - Format: `<type>(<scope>): <description>`
  - Types: `feat`, `fix`, `test`, `docs`, `style`, `refactor`, `perf`, `chore`
  - Examples:
    - `feat(auth): add rate limiting for signup endpoint`
    - `fix(forms): resolve 429 error on account creation`
    - `fix(gdrive): check credential values not just row existence`
    - `style(forms): simplify address section for first-time users`
    - `refactor(address): streamline AddressSearch component`
- **Small, clear, concise commits**: Each commit message should be under 72 characters
- **One concern per commit**: Don't mix unrelated changes

### Breaking Down Changes
When implementing a feature request, separate commits by:
1. **Backend changes** (routes, services, database)
2. **Frontend changes** (components, views, stores)
3. **Bug fixes** (separate from feature work)
4. **Documentation updates** (README, CONTRIBUTING, etc.)
5. **Style/UI improvements** (separate from functionality)

Example breakdown for "Add Google Drive folder browser":
```
fix(gdrive): validate credential values before upload attempt
feat(gdrive): add folder listing endpoint
feat(gdrive): add folder info endpoint  
feat(settings): add folder browser UI component
feat(settings): add API connection test buttons
docs(readme): document new Google Drive endpoints
```

### Commit Preparation Process
1. **Itemize all changes** made during the session
2. **Group by logical concern** (feature, fix, refactor, etc.)
3. **Order for safe reversion** (dependencies first)
4. **Present to user for review** before any commits
5. **User approves or modifies** the commit plan
6. **Execute commits** one at a time with clear messages

### Files to Exclude
- Don't commit `.env` files
- Don't commit `node_modules/`
- Don't commit database files (`*.db`)
- Don't commit `dist/` or build artifacts
- Do commit all source code changes
- **ALWAYS update README.md** when making changes that affect setup, features, or API
- **ALWAYS update CONTRIBUTING.md** when making changes that affect development workflow

## Documentation Maintenance

### Mandatory Documentation Updates
- **README.md MUST be updated** when:
  - Adding new features or functionality
  - Changing API endpoints or routes
  - Adding new dependencies
  - Modifying database schema
  - Changing authentication or security features
  - Updating environment variables or configuration
  - Changing setup or installation procedures
  
- **CONTRIBUTING.md MUST be updated** when:
  - Adding new development workflows
  - Changing code style or conventions
  - Adding new testing requirements
  - Modifying setup or installation procedures
  - Updating contribution guidelines
  - Changing development dependencies

### Documentation Checklist
Before completing any feature or change:
- [ ] README.md updated with new features/changes
- [ ] CONTRIBUTING.md updated if workflow changed
- [ ] API documentation updated if endpoints changed
- [ ] Setup instructions updated if dependencies changed

## Update Notification Manifest (Production Only)

When the application is updated to a new version **in production**, admins and managers see a one-time popup with a summary of changes. This never appears in development or testing.

### Manifest file
- **Location**: `frontend/src/config/updateManifest.js`
- **Structure**: `UPDATE_MANIFEST` is an object keyed by version string (e.g. `"1.6.0"`). Each entry has:
  - `date` (string, e.g. `"2025-02"`)
  - `title` (string, e.g. `"What's new in v1.6.0"`)
  - `summary` (array of strings; each item is one bullet. Use `**text**` for bold.)

### When to update the manifest
- **Whenever you ship a new production version** (e.g. after a release tag or version bump), add an entry to `UPDATE_MANIFEST` for that version.
- Summarize changes in user-friendly language: what’s new, what’s fixed, what admins/managers need to know.
- Keep entries short and scannable (a few bullets per version).

### Behavior (do not change without good reason)
- Shown **only in production** (`import.meta.env.PROD`).
- Shown **only to admins and managers** (role `admin` or `manager`).
- Shown **once per version**; after the user dismisses, that version is not shown again (stored in `localStorage`: `opcs_update_last_seen_version`).
- **"Don't show update notifications again"** checkbox: if checked and dismissed, the popup is never shown again until the user clears `opcs_update_hide_notifications` in localStorage.

### Component
- `frontend/src/components/UpdateNotificationModal.vue` — reads manifest, checks role and production, shows modal when conditions are met.

